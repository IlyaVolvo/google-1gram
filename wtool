#!/usr/bin/env bash

# helpers for word collection postprocessing
# See loop_cleanse_dictionary.#!/bin/sh
# See clenase-disctionary.sh
set -euo pipefail
IFS=$'\n\t'

export LC_ALL=en_US.UTF-8
export LANG=en_US.UTF-8

PROG="${0##*/}"

die() { echo "[$PROG] $*" >&2; exit 1; }

usage() {
  cat <<'EOF'
Usage:
  tool <command> [args...]

Commands:

Run:
  tool help <command>
EOF
}

# -------- command implementations --------

cmd_hello() {
  # tool hello [name]
  local name="${1:-world}"
  echo "hello, $name"
}

cmd_help() {
  # tool help [command]
  if [[ $# -eq 0 ]]; then
    usage
    return 0
  fi

  local c="$1"
  if declare -F "cmd_$c" >/dev/null; then
    # Print the function body comment header as help, if present
    awk -v fn="cmd_$c" '
      $0 ~ "^"fn"\\(\\)" {infn=1}
      infn && $0 ~ /^  #/ {sub(/^  # ?/,""); print; next}
      infn && $0 !~ /^  #/ && $0 ~ /^}/ {exit}
    ' "$0" || true
  else
    die "unknown command: $c"
  fi
}
cmd_make_dictionary () {
  sed 's/,/ /' input.csv ${1:-/dev/stdin}
}

cmd_clean() {
  root=$1
  rm R*${root}.csv N*${root}.csv ${root}-VALIDATED.csv ${root}-VALIDATED.jsonl ${root}-REJECTED.csv
}
# combine validated_csv
cmd_combine_valid() {
  ls -1tr ${1}-VALIDATED.csv | xargs cat >${2:-/dev/stdout}
}
# remove duplicates
cmd_remove_dups() {
  awk -F',' '!seen[$1]++' ${1:-/dev/stdin}
}
cmd_sort_freq() {
  sort -t',' -k2,2nr ${1:-/dev/stdin}
}
# sort by frequency after concatination
cmd_sort_freq_dups() {
  awk -F',' '
    {
      key = $1
      freq = $2 + 0

      if (!(key in max) || freq > max[key]) {
        max[key] = freq
        row[key] = $0
      }
    }
    END {
      for (k in row) print row[k]
    }
' ${1:-/dev/stdin}
}
cmd_clean_leipzig_corpus(){
  FILE=${1:-/dev/stdin}
  MIN="${2:-3}"
  MAX="${3:-7}"

  awk  -v MIN="$MIN"  -v MAX="$MAX" '
    NF > 1 && length($2) > MIN && length($2) <= MAX && $2 ~ /^[[:alpha:]]+$/ {
    for (i = 2; i <= NF; i++) {
      printf "%s%s", tolower($i), (i < NF ? "," : ORS)
    }
  }'  $FILE | awk -F',' '!seen[$1]++'
}
# rm *_news_2024_100K-co* *_news_2024_100K-inv_* *_news_2024_100K-s*  *_news_2024_100K-meta*

cmd_freq_leipzig_corpus(){
  FILE=${1:-/dev/stdin}
  MIN=${2:-1}
  awk -F', *' -v MIN=$MIN '$2 >= MIN' $FILE
}

# -------- dispatcher --------
main() {
  local cmd="${1:-}"
  shift || true

  case "$cmd" in
    ""|-h|--help|help) cmd_help "$@";;
    completion)        cmd_completion "$@";;
    *)
      if declare -F "cmd_$cmd" >/dev/null; then
        "cmd_$cmd" "$@"
      else
        die "unknown command: $cmd (try: $PROG help)"
      fi
      ;;
  esac
}

main "$@"
